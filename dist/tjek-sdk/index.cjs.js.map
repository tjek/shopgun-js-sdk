{"version":3,"file":"index.cjs.js","sources":["../../lib/config-defaults.js","../../lib/storage/client-local.js","../../lib/util.js","../../lib/kits/events/tracker.js"],"sourcesContent":["export const coreUrl = 'https://squid-api.tjek.com';\nexport const eventsTrackUrl = 'https://wolf-api.tjek.com/sync';\n","const prefixKey = 'sgn-';\n\nconst storage = (() => {\n    try {\n        const storage = window.localStorage;\n\n        storage[`${prefixKey}test-storage`] = 'foobar';\n        delete storage[`${prefixKey}test-storage`];\n\n        return storage;\n    } catch (error) {\n        return {};\n    }\n})();\n\nexport function get(key) {\n    try {\n        return JSON.parse(storage[`${prefixKey}${key}`]);\n    } catch (error) {}\n}\n\nexport function set(key, value) {\n    try {\n        storage[`${prefixKey}${key}`] = JSON.stringify(value);\n    } catch (error) {}\n}\n","export function isBrowser() {\n    return typeof window === 'object' && typeof document === 'object';\n}\n\nexport function isNode() {\n    return typeof process === 'object';\n}\n\nexport function error(err, options) {\n    err.message = err.message || null;\n\n    if (typeof options === 'string') {\n        err.message = options;\n    } else if (typeof options === 'object' && options != null) {\n        for (let key in options) {\n            const value = options[key];\n            err[key] = value;\n        }\n\n        if (options.message != null) {\n            err.message = options.message;\n        }\n        if (options.code != null || options.message != null) {\n            err.code = options.code || options.name;\n        }\n        if (options.stack != null) {\n            err.stack = options.stack;\n        }\n    }\n\n    err.name = options?.name || err.name || err.code || 'Error';\n    err.time = new Date();\n\n    return err;\n}\n\nexport function uuid() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n        const r = (Math.random() * 16) | 0;\n        const v = c === 'x' ? r : (r & 0x3) | 0x8;\n\n        return v.toString(16);\n    });\n}\n\nexport function getQueryParam(field, url) {\n    const href = url || window.location.href;\n    const reg = new RegExp('[?&]' + field + '=([^&#]*)', 'i');\n    const string = reg.exec(href);\n\n    if (string) {\n        return string[1];\n    }\n    return undefined;\n}\n\nexport function getRandomNumberBetween(from, to) {\n    return Math.floor(Math.random() * to) + from;\n}\n\nexport function getOS() {\n    let name = null;\n    const ua = window.navigator.userAgent;\n\n    if (ua.indexOf('Windows') > -1) {\n        name = 'Windows';\n    } else if (ua.indexOf('Mac') > -1) {\n        name = 'macOS';\n    } else if (ua.indexOf('X11') > -1) {\n        name = 'unix';\n    } else if (ua.indexOf('Linux') > -1) {\n        name = 'Linux';\n    } else if (ua.indexOf('iOS') > -1) {\n        name = 'iOS';\n    } else if (ua.indexOf('Android') > -1) {\n        name = 'Android';\n    }\n\n    return name;\n}\n\nexport function getDeviceCategory() {\n    let deviceCategory = 'desktop';\n\n    if (navigator.platform === 'iPod' || navigator.platform === 'iPhone') {\n        deviceCategory = 'mobile';\n    } else if (navigator.platform === 'iPad') {\n        deviceCategory = 'tablet';\n    } else if (\n        navigator.platform === 'Android' ||\n        /android/gi.test(navigator.userAgent)\n    ) {\n        if (/tablet/gi.test(navigator.userAgent)) {\n            deviceCategory = 'tablet';\n        } else {\n            deviceCategory = 'mobile';\n        }\n    }\n\n    return deviceCategory;\n}\n\nexport function getPointer() {\n    let pointer = 'fine';\n\n    if (matchMedia('(pointer:coarse)').matches) {\n        pointer = 'coarse';\n    }\n\n    return pointer;\n}\n\nexport function getOrientation(width, height) {\n    if (width === height) {\n        return 'quadratic';\n    } else if (width > height) {\n        return 'horizontal';\n    } else {\n        return 'vertical';\n    }\n}\n\nexport function getScreenDimensions() {\n    const density = window.devicePixelRatio ?? 1;\n    const logical = {\n        width: window.screen.width,\n        height: window.screen.height\n    };\n    const physical = {\n        width: Math.round(logical.width * density),\n        height: Math.round(logical.height * density)\n    };\n\n    return {\n        density,\n        logical,\n        physical\n    };\n}\n\nexport function getUtcOffsetSeconds() {\n    const now = new Date();\n    const jan1 = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);\n    const tmp = jan1.toGMTString();\n    const jan2 = new Date(tmp.substring(0, tmp.lastIndexOf(' ') - 1));\n    const stdTimeOffset = (jan1 - jan2) / 1000;\n\n    return stdTimeOffset;\n}\n\nexport function getUtcDstOffsetSeconds() {\n    return new Date().getTimezoneOffset() * 60 * -1;\n}\n\nexport function getColorBrightness(color) {\n    color = color.replace('#', '');\n    var hex = parseInt((hex + '').replace(/[^a-f0-9]/gi, ''), 16);\n    const rgb = [];\n    let sum = 0;\n    let x = 0;\n\n    while (x < 3) {\n        const s = parseInt(color.substring(2 * x, 2), 16);\n        rgb[x] = s;\n\n        if (s > 0) {\n            sum += s;\n        }\n\n        ++x;\n    }\n\n    if (sum <= 381) {\n        return 'dark';\n    } else {\n        return 'light';\n    }\n}\n\nexport function btoa(str) {\n    if (isBrowser()) {\n        return window.btoa(str);\n    } else {\n        let buffer = null;\n\n        if (str instanceof Buffer) {\n            buffer = str;\n        } else {\n            buffer = Buffer.from(str.toString(), 'binary');\n        }\n\n        return buffer.toString('base64');\n    }\n}\n\nexport function chunk(arr, size) {\n    const results = [];\n\n    while (arr.length) {\n        results.push(arr.splice(0, size));\n    }\n\n    return results;\n}\n\nexport function throttle(fn, threshold = 250, scope) {\n    let last = undefined;\n    let deferTimer = undefined;\n\n    return function () {\n        const context = scope || this;\n        const now = new Date().getTime();\n        const args = arguments;\n\n        if (last && now < last + threshold) {\n            clearTimeout(deferTimer);\n\n            deferTimer = setTimeout(() => {\n                last = now;\n\n                fn.apply(context, args);\n            }, threshold);\n        } else {\n            last = now;\n            fn.apply(context, args);\n        }\n    };\n}\n\nexport function loadImage(src, callback) {\n    const img = new Image();\n\n    img.onload = () => callback(null, img.width, img.height);\n    img.onerror = () => callback(new Error());\n    img.src = src;\n\n    return img;\n}\n\nexport function distance(lat1, lng1, lat2, lng2) {\n    const radlat1 = (Math.PI * lat1) / 180;\n    const radlat2 = (Math.PI * lat2) / 180;\n    const theta = lng1 - lng2;\n    const radtheta = (Math.PI * theta) / 180;\n    let dist =\n        Math.sin(radlat1) * Math.sin(radlat2) +\n        Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);\n    dist = Math.acos(dist);\n    dist = (dist * 180) / Math.PI;\n    dist = dist * 60 * 1.1515;\n    dist = dist * 1.609344 * 1000;\n\n    return dist;\n}\n\nexport function closest(el, s) {\n    const matches =\n        Element.prototype.matches ||\n        Element.prototype.msMatchesSelector ||\n        Element.prototype.webkitMatchesSelector;\n\n    do {\n        if (matches.call(el, s)) return el;\n\n        el = el.parentElement || el.parentNode;\n    } while (el !== null && el.nodeType === 1);\n\n    return null;\n};\n\n// Method for wrapping a function that takes a callback in any position\n// to return promises if no callback is given in a call.\n// The second argument, cbParameterIndex, is the position of the callback in the original functions parameter list.\n// CoffeeScript optional parameters messes with this function arity detection,\n// not sure what to do about that, other than always setting cbParameterIndex at callsites.\nexport function promiseCallbackInterop(fun, cbParameterIndex = fun.length - 1) {\n    // This is the function that actually wraps and calls a method to return a promise.\n    const makePromise = (fun, cbParameterIndex, parameters) =>\n        new Promise((resolve, reject) => {\n            const neoCallback = (error, result) => {\n                if (error) {\n                    return reject(error);\n                }\n                return resolve(result);\n            };\n\n            const callParameters = [];\n            for (\n                let i = 0,\n                    end = Math.max(parameters.length, cbParameterIndex) + 1,\n                    asc = 0 <= end;\n                asc ? i < end : i > end;\n                asc ? i++ : i--\n            ) {\n                callParameters.push(\n                    i === cbParameterIndex ? neoCallback : parameters[i]\n                );\n            }\n\n            return fun.apply(this, callParameters);\n        });\n    // Wrapper function that decides what to do per-call.\n    return (...parameters) => {\n        if (typeof parameters[cbParameterIndex] === 'function') {\n            // Callback given, do a regular old call.\n            return fun.apply(null, parameters);\n        } else if (typeof Promise === 'function') {\n            // No callback given, and we have promise support, use makePromise to wrap the call.\n            return makePromise(fun, cbParameterIndex, parameters);\n        } else {\n            // Ain't got callback, ain't got promise support; we gotta tell the developer.\n            throw new Error(`To be able to use this asynchronous method you should:\nSupply a callback function as argument #${1 + cbParameterIndex}.\nThis callback function will be called with the method call response.\nAlternatively, when supported, it can return a Promise if no callback function is given.\\\n`);\n        }\n    };\n}\n","import fetch from 'cross-fetch';\nimport md5 from 'md5';\nimport {eventsTrackUrl as defaultEventsTrackUrl} from '../../config-defaults';\nimport * as clientLocalStorage from '../../storage/client-local';\nimport {btoa, error, throttle, uuid} from '../../util';\n\nconst createTrackerClient = () => {\n    let id = clientLocalStorage.get('client-id');\n    if (id?.data) {\n        id = id.data;\n    }\n\n    if (id == null) {\n        id = uuid();\n\n        clientLocalStorage.set('client-id', id);\n    }\n\n    return {id};\n};\n\nfunction getPool() {\n    const data = clientLocalStorage.get('event-tracker-pool');\n\n    return Array.isArray(data)\n        ? data.filter((evt) => typeof evt._i === 'string')\n        : [];\n}\n\nconst unloadHandler = () =>\n    clientLocalStorage.set('event-tracker-pool', pool.concat(getPool()));\n\nlet pool;\nclass Tracker {\n    constructor(options = {}) {\n        if (!pool) {\n            pool = getPool();\n\n            clientLocalStorage.set('event-tracker-pool', []);\n            if (typeof window !== 'undefined') {\n                window.addEventListener('beforeunload', unloadHandler, false);\n            }\n        }\n\n        for (let key in this.defaultOptions) {\n            const value = this.defaultOptions[key];\n            this[key] = options[key] || value;\n        }\n\n        this.client = options.client || createTrackerClient();\n        this.eventsTrackUrl = options.eventsTrackUrl || defaultEventsTrackUrl;\n        this.location = {\n            geohash: null,\n            time: null,\n            country: null\n        };\n        this.dispatching = false;\n        this.hasMadeInitialDispatch = false;\n\n        if (this.eventsTrackUrl) {\n            dispatch(this.eventsTrackUrl);\n            this.hasMadeInitialDispatch = true;\n        }\n    }\n    setEventsTrackUrl(eventsTrackUrl) {\n        this.eventsTrackUrl = eventsTrackUrl;\n        if (!this.hasMadeInitialDispatch) {\n            dispatch(this.eventsTrackUrl);\n            this.hasMadeInitialDispatch = true;\n        }\n    }\n    trackEvent(type, properties = {}, version = 2) {\n        if (typeof type !== 'number') {\n            throw error(new Error('Event type is required'));\n        }\n        if (this.trackId == null) {\n            return;\n        }\n\n        const evt = Object.assign({}, properties, {\n            _e: type,\n            _v: version,\n            _i: uuid(),\n            _t: Math.round(new Date().getTime() / 1000),\n            _a: this.trackId\n        });\n\n        if (this.location.geohash) {\n            evt['l.h'] = this.location.geohash;\n        }\n        if (this.location.time) {\n            evt['l.ht'] = this.location.time;\n        }\n        if (this.location.country) {\n            evt['l.c'] = this.location.country;\n        }\n\n        pool.push(evt);\n        while (pool.length > this.poolLimit) {\n            pool.shift();\n        }\n\n        dispatch(this.eventsTrackUrl);\n\n        return this;\n    }\n\n    setLocation(location) {\n        for (let key in location) {\n            const value = location[key];\n            if (Object.prototype.hasOwnProperty.call(this.location, key)) {\n                this.location[key] = value;\n            }\n        }\n\n        return this;\n    }\n\n    trackPagedPublicationOpened(properties, version) {\n        return this.trackEvent(1, properties, version);\n    }\n\n    trackPagedPublicationPageDisappeared(properties, version) {\n        return this.trackEvent(2, properties, version);\n    }\n\n    trackOfferOpened(properties, version) {\n        return this.trackEvent(3, properties, version);\n    }\n\n    trackSearched(properties, version) {\n        return this.trackEvent(5, properties, version);\n    }\n\n    trackIncitoPublicationOpened(properties, version) {\n        return this.trackEvent(11, properties, version);\n    }\n\n    createViewToken(...parts) {\n        return btoa(\n            String.fromCharCode.apply(\n                null,\n                md5([this.client.id].concat(parts).join(''), {\n                    asBytes: true\n                }).slice(0, 8)\n            )\n        );\n    }\n}\nTracker.prototype.defaultOptions = {\n    trackId: null,\n    poolLimit: 1000\n};\nexport default Tracker;\n\nlet dispatching = false;\nconst dispatchLimit = 100;\n\nlet dispatchRetryInterval = null;\nconst dispatch = throttle((eventsTrackUrl) => {\n    if (!pool) {\n        console.warn('Tracker: dispatch called with no active event pool.');\n        return;\n    }\n\n    if (dispatching === true || pool.length === 0) {\n        return;\n    }\n\n    const events = pool.slice(0, dispatchLimit);\n    let nacks = 0;\n    dispatching = true;\n\n    fetch(eventsTrackUrl, {\n        method: 'post',\n        timeout: 1000 * 20,\n        headers: {'Content-Type': 'application/json; charset=utf-8'},\n        body: JSON.stringify({events})\n    })\n        .then((response) => response.json())\n        .then((response) => {\n            dispatching = false;\n            if (dispatchRetryInterval) {\n                clearInterval(dispatchRetryInterval);\n                dispatchRetryInterval = null;\n            }\n\n            response.events.forEach((resEvent) => {\n                if (\n                    resEvent.status === 'validation_error' ||\n                    resEvent.status === 'ack'\n                ) {\n                    pool = pool.filter(\n                        (poolEvent) => poolEvent._i !== resEvent.id\n                    );\n                } else {\n                    nacks++;\n                }\n            });\n\n            // Keep dispatching until the pool size reaches a sane level.\n            if (pool.length >= dispatchLimit && nacks === 0) {\n                dispatch(eventsTrackUrl);\n            }\n        })\n        .catch((err) => {\n            dispatching = false;\n            // Try dispatching again in 20 seconds, if we aren't already trying\n            if (!dispatchRetryInterval) {\n                console.warn(\n                    \"We're gonna keep trying, but there was an error while dispatching events:\",\n                    err\n                );\n\n                dispatchRetryInterval = setInterval(\n                    () => dispatch(eventsTrackUrl),\n                    20000\n                );\n            }\n        });\n}, 4000);\n"],"names":["eventsTrackUrl","prefixKey","storage","window","localStorage","error","get","key","JSON","parse","set","value","_JSON$stringify","isBrowser","document","err","options","message","code","name","stack","time","Date","uuid","replace","c","r","Math","random","v","toString","btoa","str","buffer","Buffer","from","throttle","fn","threshold","scope","last","undefined","deferTimer","context","now","getTime","args","arguments","clearTimeout","_setTimeout","apply","createTrackerClient","id","clientLocalStorage","data","getPool","_Array$isArray","_filterInstanceProperty","evt","_i","unloadHandler","_concatInstanceProperty","pool","Tracker","addEventListener","defaultOptions","client","defaultEventsTrackUrl","location","geohash","country","dispatching","hasMadeInitialDispatch","dispatch","type","properties","version","Error","trackId","_Object$assign","_e","_v","_t","round","_a","push","length","poolLimit","shift","Object","prototype","hasOwnProperty","call","trackEvent","parts","String","fromCharCode","_sliceInstanceProperty","md5","join","asBytes","dispatchLimit","dispatchRetryInterval","console","warn","events","nacks","fetch","method","timeout","headers","body","then","response","json","clearInterval","resEvent","status","poolEvent","catch","_setInterval"],"mappings":"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"}