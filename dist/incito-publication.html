<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Incito Publication</title>

        <meta name="viewport" content="width=device-width, user-scalable=no">
        <meta charset="utf-8">
        <style>
            body {
                margin: 0;
                font-size: 16px;
                line-height: 1.4;
                overflow-x: hidden;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            }
        </style>

        <link href="sgn-sdk.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div class="sgn__incito">
            <div class="sgn-incito__progress"></div>
        </div>

        <script src="sgn-sdk.js" id="sgn-sdk" data-app-key="00j4o5wpwptl84fuubdig2s6ej5uyna8" data-track-id="00j4o5wpwptl84fuubdig2s6ej5uyna8"></script>
        <script>
            function IncitoPublication (options) {
                this.options = options || {};
                this.popover = null;
                this.detailsId = null;
                this.details = null;
                this.bootstrapper = new SGN.IncitoPublicationKit.Bootstrapper({
                    el: this.options.el,
                    id: this.options.id,
                    eventTracker: this.options.eventTracker
                });
            }

            IncitoPublication.prototype.start = function (callback) {
                var self = this;

                this.bootstrapper.fetch(function (err, res) {
                    if (err) {
                        callback(err);
                    } else {
                        var viewer = self.createviewer(res.data.node.incito);

                        viewer.start();

                        callback(null, viewer);
                    }
                });
            };

            IncitoPublication.prototype.closeDetails = function () {
                if (this.details) {
                    this.details.destroy();
                    this.detailsId = null;
                    this.details = null;
                }
            };

            IncitoPublication.prototype.closePopover = function () {
                if (this.popover) {
                    this.popover.destroy();
                    this.popover = null;
                }
            };

            IncitoPublication.prototype.scrollTo = function (elementY, duration) {
                var startingY = window.pageYOffset;
                var diff = elementY - startingY;
                var start;

                window.requestAnimationFrame(function step (timestamp) {
                    if (!start) start = timestamp;

                    var time = timestamp - start;
                    var percent = Math.min(time / duration, 1);

                    window.scrollTo(0, startingY + diff * percent);

                    if (time < duration) {
                        window.requestAnimationFrame(step);
                    }
                });
            };

            IncitoPublication.prototype.createviewer = function (incito) {
                var self = this;
                var viewer = this.bootstrapper.createViewer({
                    incito: incito
                });

                viewer.bind('view_clicked', function (e) {
                    if (self.detailsId === e.incito.id) {
                        self.closeDetails();

                        return;
                    }

                    self.closeDetails();

                    var contentEl = document.createElement('div');
                    var rect = e.el.getBoundingClientRect();

                    contentEl.innerHTML = 'insert your custom HTML here';

                    self.detailsId = e.incito.id;
                    self.details = new SGN.CoreUIKit.OfferDetails({
                        anchorEl: e.el,
                        contentEl: contentEl
                    });
                    self.details.appendTo(document.body);

                    var threshold = self.details.el.offsetHeight;

                    if (rect.height + rect.top > window.innerHeight - threshold) {
                        self.scrollTo(rect.top + window.pageYOffset - (window.innerHeight - rect.height) + threshold, 300);
                    }
                });

                viewer.bind('view_context_clicked', function (e) {
                    self.pickProduct(e, function (product) {
                        console.log('product selected', product);
                    });
                });

                viewer.bind('view_long_clicked', function (e) {
                    self.pickProduct(e, function (product) {
                        console.log('product selected', product);
                    });
                });

                return viewer;
            };

            IncitoPublication.prototype.pickProduct = function (e, callback) {
                this.closeDetails();
                this.closePopover();

                if (e.incito.role !== 'offer') {
                    return;
                }

                this.popover = SGN.CoreUIKit.singleChoicePopover({
                    el: document.body,
                    header: SGN.translations.t('incito_publication.product_picker.header'),
                    x: e.originalEvent.clientX || e.originalEvent.touches[0].clientX,
                    y: e.originalEvent.clientY || e.originalEvent.touches[0].clientY,
                    items: e.incito.meta.products.map(function (product) {
                        return {
                            title: product.title
                        };
                    })
                }, callback);
            };

            var incitoPublication = new IncitoPublication({
                el: document.querySelector('.sgn__incito'),
                id: SGN.util.getQueryParam('id'),
                eventTracker: SGN.config.get('eventTracker')
            });

            incitoPublication.start(function (err, viewer) {
                if (err) {
                    console.log(err);
                }
            });
        </script>
    </body>
</html>
