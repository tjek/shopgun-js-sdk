<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Elgiganten: Paged Publications</title>

        <meta name="viewport" content="width=device-width, user-scalable=no">
        <meta charset="utf-8">

        <link href="https://d21oefkcnoen8i.cloudfront.net/sgn-sdk-2.2.5.min.css" rel="stylesheet" type="text/css">
        <style>
            #publications {
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: row;
                -ms-flex-direction: row;
                flex-direction: row;
                -webkit-flex-wrap: wrap;
                -ms-flex-wrap: wrap;
                flex-wrap: wrap;
                -webkit-justify-content: center;
                -ms-flex-pack: center;
                justify-content: center;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: flex-start;
                -ms-flex-align: start;
                align-items: flex-start;
                min-height: 100px;
            }

            .publications__item {
                text-align: center;
                margin: 10px;
                padding: 0 50px;
                transition: transform ease 300ms;
            }

            .publications__item:hover {
                transform: scale(1.1);
            }

            .publications__item img {
                display: block;
                max-width: 300px;
                min-height: 50px;
                cursor: pointer;
                margin: 0 auto 10px;
                border: 1px solid #eee;
                border-radius: 3px;
            }

            .publications__item div {
                font-weight: bold;
            }

            .publication--open {
                overflow: hidden;
            }

            .publication--open #publication__modal {
                display: block;
            }

            #publication__modal {
                display: none;
                position: fixed;
                z-index: 500;
                user-select: none;
                background-color: #fff;
            }

            #publication__modal .sgn-pp__hotspot {
                border-color: #88d41b;
            }

            #publication__modal .sgn__btn {
                text-decoration: none;
            }
        </style>
    </head>
    <body>
        <div id="publications"></div>

        <div id="publication__modal" class="sgn__pp" data-layout-absolute="true">
            <header class="sgn-pp__header sgn__navbar">
                <section class="sgn-navbar__section">
                    <a id="publication-modal__close" class="sgn__btn sgn-btn--fab" href='#'>
                        &times;
                    </a>
                </section>
                <section class="sgn-navbar__section"></section>
            </header>

            <div class="verso">
                <div class="verso__scroller">
                    <div class="sgn-pp__pages"></div>
                </div>
            </div>

            <div class="sgn-pp__progress">
                <div class="sgn-pp-progress__bar"></div>
            </div>

            <div class="sgn-pp__progress-label"></div>

            <a class="sgn-pp__control" href="#" role="button" data-direction="prev">&lsaquo;</a>
            <a class="sgn-pp__control" href="#" role="button" data-direction="next">&rsaquo;</a>
        </div>

        <script>
            (function () {
                var once = function (f) {
                    var done = false;
                    return function() {
                        if(!done) {
                            done = true;
                            return f.apply(this, arguments);
                        }
                    };
                }
                var initialized = false;
                var orderBys = {
                    newest: '-publication_date',
                    oldest: 'publication_date'
                };
                var config = {
                    businessId: 'c35es',
                    orderBy: 'newest'
                };
                var els = {
                    html: document.querySelector('html'),
                    root: document.querySelector('#publications'),
                    modal: document.querySelector('#publication__modal'),
                    close: document.querySelector('#publication-modal__close')
                };
                var formatDate = function (dtstr) {
                    dtstr = dtstr.replace(/\D/g, ' ');

                    var dtcomps = dtstr.split(' ');

                    dtcomps[1]--;
  
                    return new Date(Date.UTC(dtcomps[0],dtcomps[1],dtcomps[2],dtcomps[3],dtcomps[4],dtcomps[5]));
                };
                var getPublicationRuntimeEventLabel = function (data) {
                    return data.run_from.substr(0, 10) + '/' + data.run_till.substr(0, 10);
                }
                var fetchPublications = function (callback) {
                    SGN.CoreKit.request({
                        url: '/v2/catalogs',
                        qs: {
                            dealer_id: config.businessId,
                            order_by: orderBys[config.orderBy],
                            offset: 0,
                            limit: 4
                        }
                    }, callback);
                };
                var renderPublications = function (publications) {
                    var html = '';

                    publications.forEach(function (item) {
                        var runFrom = formatDate(item.run_from);
                        var runTill = formatDate(item.run_till);
                        var formattedDate = ['Fra ', runFrom.getDate(), '/', runFrom.getMonth() + 1, ' t.o.m. ', runTill.getDate(), '/', runTill.getMonth() + 1].join('');

                        html += '<div class="publications__item">';
                        html += '<img data-id="' + item.id + '" src="' + item.images.view + '">';
                        html += '<div>' + formattedDate + '</div>';
                        html += '</div>';
                    });

                    els.root.innerHTML = html;
                };
                var matchSKU = function (str) {
                    var matches = str.match(/[a-z0-9A-Z]{6,20}/gim) || [];

                    for (var i = 0; i < matches.length; i++) {
                        if (matches[i].toUpperCase() === matches[i]) {
                            return matches[i];
                        }
                    }

                    if (str.split(' ').length === 1) {
                        return str;
                    }
                };
                var fetchOffers = function (id, callback) {
                    var offset = 0;
                    var limit = 100;
                    var offers = [];
                    var fetch = function () {
                        SGN.CoreKit.request({
                            url: '/v2/offers',
                            qs: {
                                catalog_id: id,
                                offset: offset,
                                limit: limit
                            }
                        }, function (err, res) {
                            if (err) {
                                callback(err);
                            } else if (res.length < limit) {
                                offers = offers.concat(res);

                                callback(null, offers);
                            } else {
                                offset += limit;
                                offers = offers.concat(res);

                                fetch();
                            }
                        });
                    };

                    fetch();
                };
                var openActivePublication = function (pageNumber) {
                    fetchPublications(function (err, res) {
                        if (!err && res && res.length > 0) {
                            res.sort((a, b) => {
                                var aDate = formatDate(a.run_from).getTime();
                                var bDate = formatDate(b.run_from).getTime();
                                
                                return aDate - bDate;
                            });

                            openPublication(res[0].id, pageNumber);
                        }
                    });
                };
                var openPublication = function (id, pageNumber) {
                    var options = {
                        el: els.modal,
                        id: id,
                        eventTracker: SGN.config.get('eventTracker')
                    };

                    if (typeof pageNumber === 'number' && pageNumber > 0) {
                        options.pageId = 'page' + encodeURIComponent(pageNumber);
                    }
                    
                    window.scrollTo(0, 0);

                    els.html.classList.add('publication--open');

                    var bootstrapper = new SGN.PagedPublicationKit.Bootstrapper(options);

                    bootstrapper.fetch(function (err, data) {
                        if (!err) {
                            var viewer = bootstrapper.createViewer(data);
                            var _fetchHotspots = bootstrapper.fetchHotspots.bind(bootstrapper);
                            var _fetchOffers = function (callback) {
                                return fetchOffers(id, callback);
                            };

                            viewer.bind('hotspotClicked', function (hotspot) {
                                if (hotspot.sku) {
                                    n('send', 'event', {
                                        'eventCategory': 'Publication',
                                        'eventAction': 'Offer Opened',
                                        'eventLabel': getPublicationRuntimeEventLabel(hotspot.offer)+'-'+hotspot.sku
                                    });
                                }
                                if (hotspot.webshop) {
                                    window.open(hotspot.webshop, '_blank');
                                } else if (hotspot.sku) {
                                    window.open('https://www.elgiganten.dk/product/' + encodeURIComponent(hotspot.sku) + '/?intcid=PDF_HOTSPOT', '_blank');
                                }
                            });
                            var trackProgress = function (progress) {
                                n('send', 'event', {
                                    'eventCategory': 'Publication',
                                    'eventAction': 'Read-through percent',
                                    'eventLabel': getPublicationRuntimeEventLabel(data.details),
                                    'eventValue': progress
                                });
                            }
                            var navigationHandlers = {
                                page2: once(function () {
                                    n('send', 'event', {
                                        'eventCategory': 'Publication',
                                        'eventAction': 'Read-through page 2',
                                        'eventLabel': getPublicationRuntimeEventLabel(data.details)
                                    });
                                }),
                                progress20: once(function () { trackProgress(20) }),
                                progress40: once(function () { trackProgress(40) }),
                                progress60: once(function () { trackProgress(60) }),
                                progress80: once(function () { trackProgress(80) }),
                                progress100: once(function () { trackProgress(100) })
                            }
                            if (!(typeof pageNumber === 'number' && pageNumber > 1)) {
                                viewer.bind('beforeNavigation', function (navEvent) {
                                    if (navEvent.verso.newPosition === 1) {
                                        navigationHandlers.page2();
                                    }
                                    if (navEvent.progress >= 20) {
                                        navigationHandlers.progress20();
                                    }
                                    if (navEvent.progress >= 40) {
                                        navigationHandlers.progress40();
                                    }
                                    if (navEvent.progress >= 60) {
                                        navigationHandlers.progress60();
                                    }
                                    if (navEvent.progress >= 80) {
                                        navigationHandlers.progress80();
                                    }
                                    if (navEvent.progress >= 100) {
                                        navigationHandlers.progress100();
                                    }
                                });
                            }

                            viewer.start();

                            n('send', 'event', {
                                'eventCategory': 'Publication',
                                'eventAction': 'Opened',
                                'eventLabel': getPublicationRuntimeEventLabel(data.details)
                            });

                            // Fetch hotspots after rendering the viewer as they are not critical for initial render.
                            SGN.util.async.parallel([_fetchHotspots, _fetchOffers], function (result) {
                                var hotspots = result[0][1];
                                var offers = result[1][1];

                                if (hotspots && offers) {
                                    bootstrapper.applyHotspots(viewer, hotspots.filter(function (hotspot) {
                                        for (let i = 0; i < offers.length; i++) {
                                            if (hotspot.type === 'offer' && hotspot.id === offers[i].id) {
                                                var sku = matchSKU(offers[i].description);

                                                if (sku) {
                                                    hotspot.sku = sku.toUpperCase();

                                                    return true;
                                                } else if (hotspot.webshop) {
                                                    return true;
                                                }
                                            }
                                        }

                                        return false;
                                    }));
                                }
                            });

                            var close = function (e) {
                                e.preventDefault();

                                els.close.removeEventListener('click', close);
                                els.html.classList.remove('publication--open');
                                viewer.destroy();
                            };

                            els.close.addEventListener('click', close);
                        }
                    });
                };
                var init = function () {
                    if (!els.root || initialized) {
                        return;
                    }

                    var autoopen = SGN.util.getQueryParam('autoopen') || '';

                    initialized = true;

                    els.root.addEventListener('click', function (e) {
                        if (e.target.tagName === 'IMG') {
                            var id = e.target.dataset.id;

                            openPublication(id);
                        }
                    });

                    fetchPublications(function (err, res) {
                        if (!err) {
                            renderPublications(res);

                            var parts = autoopen.split(',');

                            if (parts[0] === 'future') {
                                if (res[res.length - 1]) {
                                    openPublication(res[res.length - 1].id, parseInt(parts[1]));
                                }
                            } else if (parts[0] === 'current') {
                                if (res[0]) {
                                    openPublication(res[0].id, parseInt(parts[1]));
                                }
                            } else if (parts[0].length > 0) {
                                for (var i = 0; i < res.length; i++) {
                                    if (parts[0] === res[i].id && res[i].dealer_id === config.businessId) {
                                        openPublication(res[i].id, parseInt(parts[1]));

                                        break;
                                    }
                                }
                            }
                        }
                    });
                };

                window.shopgun = {
                    init: init,
                    openActivePublication: openActivePublication
                };
            })();
        </script>
        <script src="https://d21oefkcnoen8i.cloudfront.net/sgn-sdk-2.2.5.min.js" id="sgn-sdk" data-app-key="00jiy8zh8pcorcq4sz208bryny3u76zk" data-track-id="AAACDA==" async onload="window.shopgun.init();"></script>
    </body>
</html>
