<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Pulse: Snippet of real-time activity in the Tjek shopping apps</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, user-scalable=no"
        />
        <script src="../dist/shopgun-sdk/sgn-sdk.js"></script>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                    Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji',
                    'Segoe UI Emoji', 'Segoe UI Symbol';
            }

            #map {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>

        <script>
            var es = new EventSource('https://wolf-api.tjek.com/pulse');
            var styles = [
                {
                    featureType: 'transit',
                    stylers: [{visibility: 'off'}]
                },
                {
                    featureType: 'road',
                    elementType: 'labels',
                    stylers: [{visibility: 'off'}]
                },
                {
                    featureType: 'administrative',
                    elementType: 'labels',
                    stylers: [{visibility: 'off'}]
                },
                {
                    elementType: 'geometry',
                    stylers: [{color: '#f9f9f9'}]
                },
                {
                    featureType: 'poi.park',
                    elementType: 'geometry',
                    stylers: [{color: '#88A501'}]
                },
                {
                    featureType: 'administrative.province',
                    elementType: 'geometry.stroke',
                    stylers: [{color: '#8AA31B'}]
                },
                {
                    featureType: 'water',
                    elementType: 'geometry',
                    stylers: [{color: '#ffffff'}]
                }
            ];

            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';

                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }

                return color;
            }

            function initialize() {
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 7,
                    disableDefaultUI: true,
                    center: {lat: 58, lng: 12},
                    styles: styles
                });

                es.onmessage = function (evt) {
                    var geohash = JSON.parse(evt.data);
                    var coords = Geohash.decode(geohash);
                    var verticalNoise = (Math.random() - 0.5) * 0.087 * 2;
                    var horizontalNoise = (Math.random() - 0.5) * 0.18 * 2;
                    var center = new google.maps.LatLng({
                        lat: coords.lat + verticalNoise,
                        lng: coords.lon + horizontalNoise
                    });
                    var overlay = new google.maps.Circle({
                        strokeWeight: 0,
                        fillColor: getRandomColor(),
                        fillOpacity: 0.8,
                        map: map,
                        center: center,
                        radius: 7000
                    });

                    setTimeout(function () {
                        google.maps.event.clearListeners(
                            overlay,
                            'click_handler_name'
                        );
                        google.maps.event.clearListeners(
                            overlay,
                            'drag_handler_name'
                        );

                        overlay.setRadius(0);
                        overlay.setMap(null);
                    }, 10000);
                };
            }
        </script>
        <script src="js/latlon-geohash.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9dvsFBrmZYghZQIrHzmNx9AgGTM0cuYE&callback=initialize"></script>
    </body>
</html>
